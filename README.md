# Система прогнозирования и предупреждения возникновения аварийных ситуаций на водоканале
# https://карта-водоканала.рф

## Интерфейс предиктивно-рекомендательной системы 

![Forecast comparison](https://github.com/Flaysty/watermap/raw/main/docs/interface.png)
Видны текущие отклонения и прогнозы технологических ситуаций

![Forecast comparison](https://github.com/Flaysty/watermap/raw/main/docs/interface_2.png)
Видны прогнозы отклонений, технологических ситуаций и рекомендации системы

![Forecast comparison](https://github.com/Flaysty/watermap/blob/main/docs/taskmaster/7.png)

Мобильный интерфейс бригадира, подробнее здесь: https://github.com/Flaysty/watermap/blob/main/docs/taskmaster

### Описание

Проект предоставляет систему прогнозирования и оповещения о аварийных ситуациях на водоканале, предоставляет подробный отчет для дальнейшей проверки и реагирования техническим специалистом.


### Установка
1. Убедитесь, что у вас OS Linux и установлен Docker и DockerCompose.
2. Склонируйте репозиторий:
   ```bash
   git clone https://github.com/Flaysty/watermap.git
   ```
3. Перейдите в папку проекта:
   ```bash
   cd watermap
   ```

### Использование   
1. Запустите программу:
   ```bash
   docker-compose up
   ```   
2. В браузере перейдите по адресу http://localhost:3081

### Требования   
- Linux
- Docker
- DockerCompose

## Оценка качества прогнозирования различных подходов

| series_name               | model              | n_folds | n_eval_points |  mae  | rmse  | smape | mae_h1 | mae_h24 | mae_h96 | loss  |
|---------------------------|--------------------|:------:|:-------------:|:-----:|:-----:|:-----:|:------:|:-------:|:-------:|:-----:|
| Потребление за период, м3 | Linear Regression  |   4    |      384      | 0.11  | 0.16  | 79.61 |  0.02  |  0.04   |  0.23   | 79.61 |
| Потребление за период, м3 | LGBM               |   4    |      384      | 0.03  | 0.05  | 20.11 |  0.02  |  0.02   |  0.02   | 20.11 |
| Потребление за период, м3 | Transformer        |   6    |      576      | 0.06  | 0.08  | 33.49 |  0.02  |  0.02   |  0.09   | 33.49 |

* Просмотреть и запустить моделирование можно здесь: https://colab.research.google.com/drive/1uWrN-9JtGUzCNBO7cQZr5lm4gkUj5OLk?usp=sharing
* Сам скрипт можно скачать здесь: https://github.com/Flaysty/watermap/blob/main/docs/Vodokanal_EDA_model.ipynb
* **LGBM** демонстрирует наилучшее качество прогноза (MAE≈0.03, SMAPE≈20%), заметно опережая **Linear Regression** (SMAPE≈80%) и **Transformer** (SMAPE≈33%).
  
(*) На примере ГВС/ХВС


### Как выглядит результат моделирования
![Forecast comparison](https://github.com/Flaysty/watermap/raw/main/docs/prediction.png)

**Описание графика:** линии показывают фактическое (сплошная) потребление и прогноз (пунктирная) модели на горизонте в 4х суток.

## Сценарии аварийных ситуаций

* Для генерации данных по этим сценариям используется скрипт: https://github.com/Flaysty/watermap
* Ноутбук, в котором можно запустить генерацию: https://colab.research.google.com/drive/1eFdRcRFH9X9mGW44FlGzDVNzi4Od39ce?usp=sharing
* Сгенерированные сценарии можно найти здесь: https://github.com/Flaysty/watermap/tree/main/docs/scenario


### 1) Прорыв магистрального водовода
**Причина:** коррозия, гидроудар, работы подрядчика.  
**Признаки (SCADA/датчики):** резкое падение давления в зоне, скачок расхода, провал «объёма реализации», рост «недоучтённой воды», жалобы.  
**Риски:** подмыв, отключения кварталов, подсос загрязнений.  
**Первые действия:** локализация задвижками, снижение напора, обход/геофон, выезд бригады, оповещение диспетчеров.  
**KPI на панели:** ↓ объём подачи/реализации, ↑ объём и доля недоучтённой воды, ↑ аварии, ↑ жалобы.

### 2) Отказ насосной станции (МНС/НС водоснабжения)
**Причина:** отказ агрегата/ЧРП, подшипники.  
**Признаки:** падение напора до/после, авария по току, рост температуры подшипника, вибрации.  
**Риски:** недоподача, кавитация соседних агрегатов.  
**Первые действия:** перевод на резервный насос, переключение линий, проверка ЧРП/питания, вызов мехбригады.  
**KPI:** ↓ объём подачи, возможный ↑ удельной электроэнергии (вода), ↑ аварии.

### 3) Отключение электропитания + не стартует ДГУ
**Причина:** авария 6–10 кВ, неисправность АВР/ДГУ.  
**Признаки:** обесточивание узла, нулевой расход/напор, тревоги АВР/ДГУ, падение уровня в РЧВ.  
**Риски:** остановка подачи/очистки, санитарные нарушения.  
**Первые действия:** ручной запуск ДГУ, приоритизация узлов, снижение режимов, уведомление сетевой компании.  
**KPI:** ↑ потребление ГСМ (если ДГУ в работе), ↓ объём подачи/реализации, ↑ аварии.

### 4) Срыв коагуляции на ВПУ (рост мутности)
**Причина:** неверная доза коагулянта/pH, «холодная» вода, отказ мешалки.  
**Признаки:** рост мутности после осветлителей/фильтров, рост промывок, падение длительности фильтроциклов.  
**Риски:** выход за нормативы качества.  
**Первые действия:** корректировка дозы коагулянта/щелочи, проверка расходомеров, ускоренная промывка фильтров.  
**KPI:** ↑ расход коагулянта, возможно ↑ электроэнергии (вода), ↑ жалобы.

### 5) Срыв дезинфекции (остаточный хлор ≈ 0 или > нормы)
**Причина:** пустой бак, подсос воздуха, сбой насоса-дозатора.  
**Признаки:** нулевой/завышенный остаточный хлор, тревоги ORP, жалобы на вкус/запах.  
**Риски:** микробиологические или органолептические риски.  
**Первые действия:** корректировка дозы, переключение на резервную линию, экспресс-анализы, ограничение подачи в контуре.  
**KPI:** колебания расхода хлора, ↑ жалобы, ↑ аварии (качество).

### 6) Загрязнение источника (нефтепродукты/токсины)
**Причина:** аварийный сброс в водоисточник.  
**Признаки:** рост УПАВ/UV254, пленка/запах, аномальный цвет.  
**Риски:** токсикология, остановка водозабора.  
**Первые действия:** перевод водозабора/резерв, дозирование активированного угля, информирование надзора.  
**KPI:** ↑ реагенты (коагулянт/уголь), ↓ подача/реализация, ↑ жалобы.

### 7) Массовый приток в канализацию (ливень/таяние) — риск переливов
**Причина:** притоки/инфильтрация (I/I), перегруз сети.  
**Признаки:** рост уровня/расхода на КНС и входе КОС, насосы на максимум, предупреждения о переполнении.  
**Риски:** переливы, разжижение активного ила, срыв биологии.  
**Первые действия:** перераспределение потоков, запуск резервных ниток, временные накопители/байпас, уведомление по ливневке.  
**KPI:** ↑ объём стоков, ↑ электроэнергия (стоки), ↑ аварии.

### 8) Засор/коллапс канализационного коллектора
**Причина:** мусор, корневая инвазия, просадка трубы.  
**Признаки:** рост уровней при падении расхода, жалобы на подтопления/запах, «качание» КНС.  
**Риски:** выход стоков на поверхность, ущерб.  
**Первые действия:** ТВ-инспекция, прочистка, вакуум-машина, временный перекачивающий байпас.  
**KPI:** ↑ аварии (стоки), ↑ жалобы, возможный ↓ электроэнергии (стоки) при остановке нитки.

### 9) Утечка хлора (газ) на хлораторной
**Причина:** разгерметизация баллона/соединений.  
**Признаки:** срабатывание газоанализатора, падение давления в баллоне, тревога вентиляции.  
**Риски:** поражение персонала, остановка дезинфекции.  
**Первые действия:** СИЗОД, аварийная вентиляция, эвакуация, перекрытие, перевод на гипохлорит (если есть).  
**KPI:** скачки расхода хлора, ↑ аварии по качеству/безопасности.

### 10) Резкий рост недоучтённой воды (NRW) в DMA
**Причина:** скрытая утечка, нелегальная врезка, отказ узла учёта.  
**Признаки:** рост ночного минимума, дисбаланс «подача → реализация», стагнация давления.  
**Риски:** потери, подмывы, вторичное загрязнение.  
**Первые действия:** анализ DMA, акустика/коррелятор, проверка счётчиков, изоляция участка.  
**KPI:** ↑ объём/доля недоучтённой воды, ↓ реализация.

### 11) Киберинцидент/сбой SCADA
**Причина:** ransomware, неудачное обновление, сбой OPC.  
**Признаки:** потеря телеметрии, недостоверные показания, недоступность телеуправления.  
**Риски:** неверные режимы, запаздывание реакции.  
**Первые действия:** переход на локальные панели/ручное управление, изоляция сети, запуск резервного сервера, восстановление из бэкапа.  
**KPI:** косвенно ↑ аварии, отклонения энергии/качества.

### 12) Некачественное топливо/неисправность ДГУ
**Причина:** вода в дизтопливе, забитые фильтры, отказ подогрева.  
**Признаки:** нестабильная работа, защитные отключения, недозаряд АКБ.  
**Риски:** потеря резерва при реальной аварии.  
**Первые действия:** замена топлива/фильтров, проверка подогрева, тест-пуск под нагрузкой, сервис.  
**KPI:** ↑ потребление ГСМ (тесты/работа), ↑ аварии (надёжность).

### 13) Сбой промывки фильтров (не срабатывает автоматика)
**Причина:** заедание арматуры, отказ пневмо/ПЛК.  
**Признаки:** рост потерь напора, ухудшение качества после фильтра, просроченные циклы.  
**Риски:** прорыв взвеси в сеть.  
**Первые действия:** ручная промывка, проверка клапанов/компрессора/соленоидов, перевод на резервную нитку.  
**KPI:** ↑ удельная электроэнергия (вода), ↑ расход воды на промывки, ↑ жалобы.

### 14) Контаминация резервуара (биоплёнка/водоросли)
**Причина:** застой, неработающие мешалки/рециркуляция, тёплая погода.  
**Признаки:** запах/привкус, рост ХПК/перманганатной окисляемости, локальные жалобы.  
**Риски:** ухудшение качества в зоне РЧВ.  
**Первые действия:** вывод РЧВ на санитарную мойку/дезинфекцию, ротация резервуаров, усиление остаточного хлора.  
**KPI:** ↑ расход хлора, ↓ реализация (локальные ограничения), ↑ жалобы.

## пример работы рекомендательного сервиса в интерфейсе системы
![Forecast comparison](https://github.com/Flaysty/watermap/blob/main/docs/recomendations.jpg)

## Архитектурная схема системы
![Forecast comparison](https://github.com/Flaysty/watermap/blob/main/docs/arch.jpg)

## Стэк технологий: 
**Back:** Python (lightgbm, scikit-learn, statsmodels, SARIMAX, numpy, torch, TimeSeriesTransformer)
**Front:** React JS
**BD:** MySQL/PostgreSQL

